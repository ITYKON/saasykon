generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model addresses {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String?    @db.Uuid
  label        String?
  line1        String
  line2        String?
  postal_code  String?
  city_id      Int?
  country_code String?    @db.Char(2)
  latitude     Float?
  longitude    Float?
  is_default   Boolean?   @default(false)
  cities       cities?    @relation(fields: [city_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  countries    countries? @relation(fields: [country_code], references: [code], onDelete: NoAction, onUpdate: NoAction)
  users        users?     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model business_leads {
  id                     String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_name          String
  owner_first_name       String
  owner_last_name        String
  email                  String
  phone                  String?
  activity_type          String?
  location               String?
  notes                  String?
  status                 lead_status             @default(pending)
  converted_by           String?                 @db.Uuid
  created_at             DateTime                @default(now()) @db.Timestamptz(6)
  updated_at             DateTime                @default(now()) @db.Timestamptz(6)
  claim_token            String?                 @unique
  token_expires          DateTime?               @db.Timestamptz(6)
  documents_uploaded     Boolean?                @default(false)
  trial_ends_at          DateTime?               @db.Timestamptz(6)
  verification_id        String?                 @db.Uuid
  archived_at            DateTime?               @db.Timestamptz(6)
  deleted_at             DateTime?               @db.Timestamptz(6)
  users                  users?                  @relation(fields: [converted_by], references: [id], onUpdate: NoAction, map: "business_leads_converted_by_fk")
  business_verifications business_verifications? @relation(fields: [verification_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  lead_documents         lead_documents[]

  @@index([activity_type, location], map: "business_leads_activity_location_idx")
  @@index([created_at(sort: Desc)])
  @@index([email])
  @@index([status])
}

model business_locations {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id   String         @db.Uuid
  address_line1 String
  address_line2 String?
  postal_code   String?
  city_id       Int?
  country_code  String?        @db.Char(2)
  latitude      Float?
  longitude     Float?
  timezone      String         @default("Europe/Paris")
  is_primary    Boolean        @default(true)
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  updated_at    DateTime       @default(now()) @db.Timestamptz(6)
  businesses    businesses     @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  cities        cities?        @relation(fields: [city_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  countries     countries?     @relation(fields: [country_code], references: [code], onDelete: NoAction, onUpdate: NoAction)
  reservations  reservations[]

  @@index([business_id, is_primary])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model business_media {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id String     @db.Uuid
  url         String
  type        String?
  position    Int?       @default(0)
  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  businesses  businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model business_verifications {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id           String              @db.Uuid
  rc_number             String?
  rc_document_url       String?
  id_document_front_url String?
  id_document_back_url  String?
  status                verification_status @default(pending)
  reviewed_by           String?             @db.Uuid
  reviewed_at           DateTime?           @db.Timestamptz(6)
  notes                 String?
  created_at            DateTime            @default(now()) @db.Timestamptz(6)
  updated_at            DateTime            @default(now()) @db.Timestamptz(6)
  business_leads        business_leads[]
  businesses            businesses          @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "business_verifications_business_fk")
  users                 users?              @relation(fields: [reviewed_by], references: [id], onUpdate: NoAction, map: "business_verifications_reviewed_by_fk")

  @@index([business_id], map: "business_verifications_business_idx")
  @@index([reviewed_at])
  @@index([status])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model businesses {
  id                                    String                         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  owner_user_id                         String                         @db.Uuid
  legal_name                            String
  public_name                           String
  description                           String?
  email                                 String?
  phone                                 String?
  website                               String?
  vat_number                            String?
  category_code                         String?
  logo_url                              String?
  cover_url                             String?
  created_at                            DateTime                       @default(now()) @db.Timestamptz(6)
  updated_at                            DateTime                       @default(now()) @db.Timestamptz(6)
  archived_at                           DateTime?                      @db.Timestamptz(6)
  deleted_at                            DateTime?                      @db.Timestamptz(6)
  status                                business_status                @default(pending_verification)
  onboarding_completed                  Boolean                        @default(false)
  claim_status                          String                         @default("none")
  owner_id                              String?                        @db.Uuid
  verification_status                   verification_status            @default(pending)
  trial_ends_at                         DateTime?                      @db.Timestamptz(6)
  last_reminder_sent_at                 DateTime?                      @db.Timestamptz(6)
  is_claimable                          Boolean                        @default(false)
  converted_from_lead                   Boolean                        @default(false)
  slug                                  String?                        @unique
  business_locations                    business_locations[]
  business_media                        business_media[]
  business_ownership_transfers          business_ownership_transfers[]
  business_verifications                business_verifications[]
  users_businesses_owner_idTousers      users?                         @relation("businesses_owner_idTousers", fields: [owner_id], references: [id], onUpdate: NoAction)
  users_businesses_owner_user_idTousers users                          @relation("businesses_owner_user_idTousers", fields: [owner_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  claims                                claims[]
  client_favorites                      client_favorites[]
  daily_business_stats                  daily_business_stats[]
  employee_permissions                  employee_permissions[]
  employees                             employees[]
  invoices                              invoices[]
  notifications                         notifications[]
  payments                              payments[]
  payouts                               payouts[]
  ratings_aggregates                    ratings_aggregates?
  reservations                          reservations[]
  resources                             resources[]
  reviews                               reviews[]
  services                              services[]
  subscriptions                         subscriptions[]
  user_roles                            user_roles[]
  waitlist                              waitlist[]
  working_hours                         working_hours[]

  @@index([status])
  @@index([trial_ends_at])
  @@index([verification_status])
}

model cities {
  id                 Int                  @id @default(autoincrement())
  country_code       String?              @db.Char(2)
  name               String
  wilaya_number      Int?
  addresses          addresses[]
  business_locations business_locations[]
  countries          countries?           @relation(fields: [country_code], references: [code], onDelete: NoAction, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model claims {
  id                     Int        @id @default(autoincrement())
  business_id            String     @db.Uuid
  user_id                String     @db.Uuid
  full_name              String
  email                  String
  phone                  String
  role                   String
  document_url           String?
  status                 String     @default("pending")
  expires_at             DateTime?  @db.Timestamptz(6)
  created_at             DateTime   @default(now()) @db.Timestamptz(6)
  updated_at             DateTime   @default(now()) @db.Timestamptz(6)
  claim_token            String?    @unique(map: "unique_claim_token")
  token_expires_at       DateTime?
  rc_number              String?    @db.VarChar
  rc_document_url        String?
  id_document_front_url  String?
  id_document_back_url   String?
  documents_submitted    Boolean?   @default(false)
  documents_submitted_at DateTime?  @db.Timestamptz(6)
  businesses             businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users                  users      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([business_id], map: "idx_claim_business_id")
  @@index([expires_at], map: "idx_claim_expires_at")
  @@index([status], map: "idx_claim_status")
  @@index([user_id], map: "idx_claim_user_id")
}

model client_favorites {
  client_id   String     @db.Uuid
  business_id String     @db.Uuid
  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  businesses  businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clients     clients    @relation(fields: [client_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([client_id, business_id])
}

model clients {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String?            @db.Uuid
  first_name       String?
  last_name        String?
  phone            String?
  notes            String?
  created_at       DateTime           @default(now()) @db.Timestamptz(6)
  status           client_status      @default(NOUVEAU)
  client_favorites client_favorites[]
  users            users?             @relation(fields: [user_id], references: [id], onUpdate: NoAction)
  invoices         invoices[]
  reservations     reservations[]
  reviews          reviews[]
  waitlist         waitlist[]

  @@index([status])
}

model countries {
  code               String               @id @db.Char(2)
  name               String
  addresses          addresses[]
  business_locations business_locations[]
  cities             cities[]
}

model daily_business_stats {
  business_id       String     @db.Uuid
  date              DateTime   @db.Date
  bookings_count    Int        @default(0)
  new_clients_count Int        @default(0)
  revenue_cents     Int        @default(0)
  rating_avg        Decimal    @default(0) @db.Decimal(3, 2)
  businesses        businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([business_id, date])
}

model employee_accounts {
  user_id     String    @id @db.Uuid
  employee_id String    @db.Uuid
  employees   employees @relation(fields: [employee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([employee_id, user_id])
}

model employee_availability_overrides {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employee_id  String    @db.Uuid
  date         DateTime  @db.Date
  is_available Boolean
  start_time   DateTime? @db.Time(6)
  end_time     DateTime? @db.Time(6)
  employees    employees @relation(fields: [employee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([employee_id, date], map: "employee_availability_overrides_employee_id_date_idx")
}

model employee_permissions {
  employee_id     String          @db.Uuid
  permission_id   Int
  business_id     String          @db.Uuid
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  businesses      businesses      @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  pro_permissions pro_permissions @relation(fields: [permission_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([employee_id, permission_id, business_id])
  @@index([business_id], map: "employee_permissions_business_idx")
  @@index([employee_id], map: "employee_permissions_employee_idx")
}

model employee_roles {
  employee_id String    @db.Uuid
  role        String
  employees   employees @relation(fields: [employee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([employee_id, role])
}

model employee_services {
  employee_id String    @db.Uuid
  service_id  String    @db.Uuid
  employees   employees @relation(fields: [employee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  services    services  @relation(fields: [service_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([employee_id, service_id])
}

model employees {
  id                              String                            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id                     String                            @db.Uuid
  full_name                       String
  email                           String?
  phone                           String?
  color                           String?
  is_active                       Boolean                           @default(true)
  created_at                      DateTime                          @default(now()) @db.Timestamptz(6)
  updated_at                      DateTime                          @default(now()) @db.Timestamptz(6)
  profession_label                String?
  employee_accounts               employee_accounts[]
  employee_availability_overrides employee_availability_overrides[]
  employee_roles                  employee_roles[]
  employee_services               employee_services[]
  businesses                      businesses                        @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  reservation_items               reservation_items[]
  reservations                    reservations[]
  time_off                        time_off[]
  working_hours                   working_hours[]

  @@index([business_id, is_active])
}

model event_logs {
  id          BigInt   @id @default(autoincrement())
  occurred_at DateTime @default(now()) @db.Timestamptz(6)
  user_id     String?  @db.Uuid
  business_id String?  @db.Uuid
  event_name  String
  payload     Json?

  @@index([business_id, occurred_at(sort: Desc)])
}

model invite_tokens {
  id                                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                               String   @db.Uuid
  email                                 String
  token_hash                            String   @unique(map: "invite_tokens_token_hash_uq")
  expires_at                            DateTime @db.Timestamptz(6)
  used                                  Boolean  @default(false)
  created_by                            String   @db.Uuid
  created_at                            DateTime @default(now()) @db.Timestamptz(6)
  users_invite_tokens_created_byTousers users    @relation("invite_tokens_created_byTousers", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "invite_tokens_created_by_fk")
  users_invite_tokens_user_idTousers    users    @relation("invite_tokens_user_idTousers", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "invite_tokens_user_fk")

  @@index([expires_at])
  @@index([user_id, used], map: "invite_tokens_user_used_idx")
}

model invoices {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id    String        @db.Uuid
  client_id      String?       @db.Uuid
  reservation_id String?       @db.Uuid
  amount_cents   Int
  currency       String        @default("EUR") @db.Char(3)
  status         String        @default("OPEN")
  issued_at      DateTime      @default(now()) @db.Timestamptz(6)
  businesses     businesses    @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clients        clients?      @relation(fields: [client_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reservations   reservations? @relation(fields: [reservation_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model lead_documents {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lead_id        String         @db.Uuid
  document_type  String
  file_url       String
  created_at     DateTime       @default(now()) @db.Timestamptz(6)
  business_leads business_leads @relation(fields: [lead_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([lead_id, document_type])
}

model login_attempts {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String?  @db.Uuid
  attempted_at DateTime @default(now()) @db.Timestamptz(6)
  success      Boolean
  ip_address   String?
  user_agent   String?
  users        users?   @relation(fields: [user_id], references: [id], onUpdate: NoAction)
}

model notification_preferences {
  user_id    String  @id @db.Uuid
  email      Boolean @default(true)
  sms        Boolean @default(false)
  push       Boolean @default(false)
  categories Json    @default("{}")
  users      users   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model notifications {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String?     @db.Uuid
  business_id String?     @db.Uuid
  type        String
  payload     Json
  is_read     Boolean     @default(false)
  created_at  DateTime    @default(now()) @db.Timestamptz(6)
  businesses  businesses? @relation(fields: [business_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users       users?      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model payment_providers {
  id            Int             @id @default(autoincrement())
  code          String          @unique
  name          String
  payments      payments[]
  subscriptions subscriptions[]
}

model payments {
  id                  String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id         String             @db.Uuid
  reservation_id      String?            @db.Uuid
  provider_id         Int?
  provider_payment_id String?
  amount_cents        Int
  currency            String             @default("EUR") @db.Char(3)
  status              payment_status
  captured_at         DateTime?          @db.Timestamptz(6)
  created_at          DateTime           @default(now()) @db.Timestamptz(6)
  businesses          businesses         @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payment_providers   payment_providers? @relation(fields: [provider_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reservations        reservations?      @relation(fields: [reservation_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refunds             refunds[]

  @@index([business_id, created_at(sort: Desc)])
}

model payouts {
  id                 String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id        String     @db.Uuid
  provider_payout_id String?
  amount_cents       Int
  currency           String     @default("EUR") @db.Char(3)
  period_start       DateTime   @db.Date
  period_end         DateTime   @db.Date
  created_at         DateTime   @default(now()) @db.Timestamptz(6)
  businesses         businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model permissions {
  id               Int                @id @default(autoincrement())
  code             String             @unique
  description      String?
  role_permissions role_permissions[]
}

model plan_features {
  id           Int     @id @default(autoincrement())
  plan_id      Int
  feature_code String
  value        String?
  plans        plans   @relation(fields: [plan_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model plans {
  id               Int             @id @default(autoincrement())
  code             String          @unique
  name             String
  price_cents      Int
  currency         String          @default("EUR") @db.Char(3)
  billing_interval String
  trial_days       Int?            @default(0)
  is_active        Boolean         @default(true)
  plan_features    plan_features[]
  subscriptions    subscriptions[]
}

model pro_permissions {
  id                   Int                    @id @default(autoincrement())
  code                 String                 @unique
  description          String?
  employee_permissions employee_permissions[]

  @@index([code])
}

model ratings_aggregates {
  business_id     String     @id @db.Uuid
  rating_avg      Decimal    @default(0) @db.Decimal(3, 2)
  rating_count    Int        @default(0)
  last_updated_at DateTime   @default(now()) @db.Timestamptz(6)
  businesses      businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model refunds {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  payment_id   String   @db.Uuid
  amount_cents Int
  reason       String?
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  payments     payments @relation(fields: [payment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model reservation_items {
  id               String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reservation_id   String            @db.Uuid
  service_id       String            @db.Uuid
  variant_id       String?           @db.Uuid
  addon_ids        String[]          @default([]) @db.Uuid
  employee_id      String?           @db.Uuid
  price_cents      Int
  currency         String            @default("EUR") @db.Char(3)
  duration_minutes Int
  employees        employees?        @relation(fields: [employee_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reservations     reservations      @relation(fields: [reservation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  services         services          @relation(fields: [service_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  service_variants service_variants? @relation(fields: [variant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model reservation_status_history {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reservation_id     String              @db.Uuid
  from_status        reservation_status?
  to_status          reservation_status
  changed_by_user_id String?             @db.Uuid
  changed_at         DateTime            @default(now()) @db.Timestamptz(6)
  reason             String?
  users              users?              @relation(fields: [changed_by_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reservations       reservations        @relation(fields: [reservation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model reservations {
  id                         String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id                String                       @db.Uuid
  location_id                String?                      @db.Uuid
  client_id                  String?                      @db.Uuid
  booker_user_id             String?                      @db.Uuid
  employee_id                String?                      @db.Uuid
  starts_at                  DateTime                     @db.Timestamptz(6)
  ends_at                    DateTime                     @db.Timestamptz(6)
  status                     reservation_status           @default(PENDING)
  notes                      String?
  source                     String?                      @default("WEB")
  created_at                 DateTime                     @default(now()) @db.Timestamptz(6)
  updated_at                 DateTime                     @default(now()) @db.Timestamptz(6)
  cancelled_at               DateTime?                    @db.Timestamptz(6)
  invoices                   invoices[]
  payments                   payments[]
  reservation_items          reservation_items[]
  reservation_status_history reservation_status_history[]
  users                      users?                       @relation(fields: [booker_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  businesses                 businesses                   @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clients                    clients?                     @relation(fields: [client_id], references: [id], onUpdate: NoAction)
  employees                  employees?                   @relation(fields: [employee_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  business_locations         business_locations?          @relation(fields: [location_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reviews                    reviews[]

  @@index([business_id, starts_at])
  @@index([client_id, starts_at])
  @@index([employee_id, starts_at])
}

model resources {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id String     @db.Uuid
  name        String
  capacity    Int        @default(1)
  is_active   Boolean    @default(true)
  businesses  businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model review_photos {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  review_id String  @db.Uuid
  url       String
  position  Int?    @default(0)
  reviews   reviews @relation(fields: [review_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model reviews {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id    String          @db.Uuid
  reservation_id String?         @db.Uuid
  client_id      String?         @db.Uuid
  rating         Int
  comment        String?
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  is_public      Boolean?        @default(true)
  review_photos  review_photos[]
  businesses     businesses      @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clients        clients?        @relation(fields: [client_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reservations   reservations?   @relation(fields: [reservation_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([business_id])
}

model role_permissions {
  role_id       Int
  permission_id Int
  permissions   permissions @relation(fields: [permission_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  roles         roles       @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([role_id, permission_id])
}

model roles {
  id               Int                @id @default(autoincrement())
  code             String             @unique
  name             String
  role_permissions role_permissions[]
  user_roles       user_roles[]
}

model service_addons {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  service_id       String   @db.Uuid
  name             String
  duration_minutes Int
  price_cents      Int
  currency         String   @default("EUR") @db.Char(3)
  is_active        Boolean  @default(true)
  services         services @relation(fields: [service_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model service_categories {
  id       Int        @id @default(autoincrement())
  code     String     @unique
  name     String
  services services[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model service_variants {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  service_id            String              @db.Uuid
  name                  String?
  duration_minutes      Int
  price_cents           Int?
  price_min_cents       Int?
  price_max_cents       Int?
  currency              String              @default("EUR") @db.Char(3)
  buffer_before_minutes Int?                @default(0)
  buffer_after_minutes  Int?                @default(0)
  is_active             Boolean             @default(true)
  reservation_items     reservation_items[]
  services              services            @relation(fields: [service_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model services {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id        String              @db.Uuid
  category_id        Int?
  name               String
  description        String?
  is_active          Boolean             @default(true)
  created_at         DateTime            @default(now()) @db.Timestamptz(6)
  updated_at         DateTime            @default(now()) @db.Timestamptz(6)
  employee_services  employee_services[]
  reservation_items  reservation_items[]
  service_addons     service_addons[]
  service_variants   service_variants[]
  businesses         businesses          @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  service_categories service_categories? @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([business_id, is_active])
}

model sessions {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique
  expires_at DateTime @db.Timestamptz(6)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model subscription_invoices {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subscription_id String        @db.Uuid
  amount_cents    Int
  currency        String        @default("EUR") @db.Char(3)
  status          String        @default("OPEN")
  issued_at       DateTime      @default(now()) @db.Timestamptz(6)
  subscriptions   subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model subscriptions {
  id                       String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id              String                  @db.Uuid
  plan_id                  Int
  provider_id              Int?
  provider_subscription_id String?
  status                   subscription_status
  current_period_start     DateTime                @db.Timestamptz(6)
  current_period_end       DateTime                @db.Timestamptz(6)
  cancel_at_period_end     Boolean?                @default(false)
  created_at               DateTime                @default(now()) @db.Timestamptz(6)
  updated_at               DateTime                @default(now()) @db.Timestamptz(6)
  subscription_invoices    subscription_invoices[]
  businesses               businesses              @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  plans                    plans                   @relation(fields: [plan_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payment_providers        payment_providers?      @relation(fields: [provider_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  usage_records            usage_records[]
}

model time_off {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employee_id String    @db.Uuid
  starts_at   DateTime  @db.Timestamptz(6)
  ends_at     DateTime  @db.Timestamptz(6)
  reason      String?
  employees   employees @relation(fields: [employee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([employee_id, starts_at, ends_at])
}

model usage_records {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subscription_id String        @db.Uuid
  metric_code     String
  quantity        Int
  period_start    DateTime      @db.Timestamptz(6)
  period_end      DateTime      @db.Timestamptz(6)
  created_at      DateTime      @default(now()) @db.Timestamptz(6)
  subscriptions   subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model user_roles {
  user_id     String     @db.Uuid
  role_id     Int
  business_id String     @db.Uuid
  businesses  businesses @relation(fields: [business_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  roles       roles      @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, role_id, business_id])
}

model users {
  id                                            String                         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                                         String                         @unique
  phone                                         String?
  password_hash                                 String?
  provider                                      String?
  provider_id                                   String?
  first_name                                    String?
  last_name                                     String?
  avatar_url                                    String?
  locale                                        String?                        @default("fr")
  is_email_verified                             Boolean?                       @default(false)
  is_phone_verified                             Boolean?                       @default(false)
  created_at                                    DateTime                       @default(now()) @db.Timestamptz(6)
  updated_at                                    DateTime                       @default(now()) @db.Timestamptz(6)
  deleted_at                                    DateTime?                      @db.Timestamptz(6)
  addresses                                     addresses[]
  business_leads                                business_leads[]
  ownership_transfers_from                      business_ownership_transfers[] @relation("OwnershipTransfersFrom")
  ownership_transfers_to                        business_ownership_transfers[] @relation("OwnershipTransfersTo")
  reviewed_ownership_transfers                  business_ownership_transfers[] @relation("OwnershipTransfersReviewed")
  business_verifications                        business_verifications[]
  businesses_businesses_owner_idTousers         businesses[]                   @relation("businesses_owner_idTousers")
  businesses_businesses_owner_user_idTousers    businesses[]                   @relation("businesses_owner_user_idTousers")
  claims                                        claims[]
  clients                                       clients[]
  employee_accounts                             employee_accounts?
  invite_tokens_invite_tokens_created_byTousers invite_tokens[]                @relation("invite_tokens_created_byTousers")
  invite_tokens_invite_tokens_user_idTousers    invite_tokens[]                @relation("invite_tokens_user_idTousers")
  login_attempts                                login_attempts[]
  notification_preferences                      notification_preferences?
  notifications                                 notifications[]
  password_reset_tokens                         password_reset_tokens[]
  reservation_status_history                    reservation_status_history[]
  reservations                                  reservations[]
  sessions                                      sessions[]
  user_roles                                    user_roles[]

  @@index([provider, provider_id])
}

model waitlist {
  id                 String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id        String                    @db.Uuid
  client_id          String?                   @db.Uuid
  desired_date       DateTime                  @db.Date
  desired_time_range Unsupported("tstzrange")?
  created_at         DateTime                  @default(now()) @db.Timestamptz(6)
  status             String                    @default("OPEN")
  businesses         businesses                @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clients            clients?                  @relation(fields: [client_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model working_hours {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id String     @db.Uuid
  employee_id String?    @db.Uuid
  weekday     Int
  start_time  DateTime   @db.Time(6)
  end_time    DateTime   @db.Time(6)
  breaks      Json?      @default("[]")
  businesses  businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  employees   employees? @relation(fields: [employee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([business_id, employee_id])
}

model business_ownership_transfers {
  id                     String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  business_id            String     @db.Uuid
  current_owner_id       String     @db.Uuid
  new_owner_id           String     @db.Uuid
  status                 String     @default("pending")
  requested_at           DateTime   @default(now()) @db.Timestamptz(6)
  reviewed_at            DateTime?  @db.Timestamptz(6)
  reviewed_by            String?    @db.Uuid
  review_notes           String?
  created_at             DateTime   @default(now()) @db.Timestamptz(6)
  updated_at             DateTime   @updatedAt @db.Timestamptz(6)
  id_document_front_url  String?
  id_document_back_url   String?
  proof_of_ownership_url String?
  business               businesses @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  current_owner          users      @relation("OwnershipTransfersFrom", fields: [current_owner_id], references: [id], onUpdate: NoAction)
  new_owner              users      @relation("OwnershipTransfersTo", fields: [new_owner_id], references: [id], onUpdate: NoAction)
  reviewer               users?     @relation("OwnershipTransfersReviewed", fields: [reviewed_by], references: [id], onUpdate: NoAction)

  @@index([business_id])
  @@index([current_owner_id])
  @@index([new_owner_id])
  @@index([status])
  @@map("business_ownership_transfers")
}

model password_reset_tokens {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique
  expires_at DateTime @db.Timestamptz(6)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  used       Boolean  @default(false)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([token])
  @@index([user_id])
}

enum business_status {
  pending_verification
  verified
  active
}

enum client_status {
  VIP
  REGULIER
  NOUVEAU
  AUCUN
}

enum lead_status {
  pending
  contacted
  invited
  validated
}

enum payment_status {
  REQUIRES_ACTION
  AUTHORIZED
  CAPTURED
  REFUNDED
  FAILED
  CANCELLED
}

enum reservation_status {
  PENDING
  CONFIRMED
  CANCELLED
  NO_SHOW
  COMPLETED
}

enum subscription_status {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum verification_status {
  pending
  verified
  rejected
}
